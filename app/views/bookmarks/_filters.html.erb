<%= form_for @search, 
  url: (@collection ? collection_bookmarks_path(@collection) : bookmarks_path), 
  html: { 
    method: :get, 
    class: "narrow-hidden filters", 
    id: "bookmark-filters"
  } do |f| %>
  <h3 class="landmark heading"><%= ts("Filters") %></h3>
  <%= field_set_tag ts("Filter results:") do %>
    <%= f.submit ts("Sort and Filter") %>
      <dl>
        <dt class="sort">
          <%= f.label :sort_column, ts("Sort by") %>
        </dt>
        <dd class="sort">
          <%= f.select :sort_column, options_for_select(@search.sort_options, @search.sort_column) %>
        </dd>

        <% %w(rating warning category fandom character relationship freeform tag).each do |tag_type| %>
          <dt class="<%= tag_type.pluralize %> tags">
            <%= tag_type_label(tag_type) %>
          </dt>
          <dd id="tag_category_<%= tag_type %>_filter_options" class="expandable <%= tag_type.pluralize %> tags">
            <dl>
              <% # Make one list for including and one for excluding, each with unique ids %>
              <% %w(include exclude).each do |filter_action| %>
                <dt class="<%= filter_action %>">
                  <% # For accessibility, include tag type (e.g. Rating) as landmark text %>
                  <%= ts("%{filter_action} <span class=\"landmark\">%{tag_type}</span>",
                    filter_action: filter_action.titleize,
                    tag_type: tag_type_label(tag_type)
                    ).html_safe %>
                </dt>
                <dd id="<%= filter_action %>_tag_category_<%= tag_type %>" class="expandable <%= filter_action %>">
                  <ul>
                    <% @facets[tag_type].each do |tag| %>
                      <li>
                        <% if (tag_type == "rating") && @facets[tag_type].length > 1 %>
                          <%= radio_button_tag "#{filter_action}_bookmark_search[#{tag_type}_ids][]", 
                              tag.id, 
                              @search.send("#{tag_type}_ids").present? && @search.send("#{tag_type}_ids").include?(tag.id.to_s), 
                              id: "#{filter_action}_bookmark_search_#{tag_type}_ids_#{tag.id}" %> 
                        <% else %>
                          <%= check_box_tag "bookmark_search[#{filter_action}_#{tag_type}_ids][]", 
                              tag.id,
                              @search.send("#{tag_type}_ids").present? && @search.send("#{tag_type}_ids").include?(tag.id.to_s), 
                              id: "#{filter_action}_bookmark_search_#{tag_type}_ids_#{tag.id}" %>
                        <% end %>
                        <%= label_tag "#{filter_action}_bookmark_search_#{tag_type}_ids_#{tag.id}", 
                            "#{label_for_filter(tag_type, {name: tag.name, count: tag.count})}" %>
                      </li>
                    <% end %>
                  </ul>
                </dd>
              <% end %>
            </dl>
          <% end %>
        </dd>

        <dt class="autocomplete">
          <%= f.label 'other_tag_names', ts("Include other tags") %>
        </dt>
        <dd class="autocomplete">
          <%= f.text_field 'other_tag_names', autocomplete_options("tag") %>
        </dd>
        <dt class="search">
          <%= f.label :query, ts("Search within results") %>
          <%= link_to_help "work-search-text-help" %>
        </dt>
        <dd class="search">
          <%= f.text_field :query %>
        </dd>

      <dt>
        <%= ts("Options") %>
      </dt>
      <dd>
        <ul>
          <li>
            <%= f.check_box :rec %>
            <%= f.label :rec, ts("Recs only") %>
          </li>
          <li>
            <%= f.check_box :with_notes %>
            <%= f.label :with_notes, ts("Only bookmarks with notes") %>
          </li>
        </ul>
      </dd>
    </dl>
    <%= f.submit ts("Sort and Filter") %>
    <div>
      <%= hidden_field_tag("collection_id", @collection.id) if @collection %>
      <%= hidden_field_tag("tag_id", @tag.to_param) if @tag %>
      <%= hidden_field_tag("fandom_id", @fandom.id) if @fandom %>
      <%= hidden_field_tag("pseud_id", @pseud.name) if @pseud %>
      <%= hidden_field_tag("user_id", @user.login) if @user %>
    </div>
  <% end %>
  <% # On narrow screens, link jumps to top of index when JavaScript is disabled and closes filters when JavaScript is enabled %>
  <p class="narrow-shown hidden">
    <a href="#main" id="leave_filters" class="close">
      <%= ts("Top of Bookmark Index") %>
    </a>
  </p>
<% end %>
